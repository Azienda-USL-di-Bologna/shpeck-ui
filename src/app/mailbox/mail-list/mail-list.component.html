<!--
       [lazy]="true" (onLazyLoad)="lazyLoad($event)"
    [value]="messages"
    [columns]="cols"
    [paginator]="false"
    [autoLayout]="false"
    [responsive]="true"
    [totalRecords]="totalRecords"
    selectionMode="multiple"
    [metaKeySelection]="true"
    [scrollable]="true" [virtualRowHeight]="10" [virtualScroll]="true"
    (onRowSelect)="handleEvent('onRowSelect', $event)"
-->
<!-- <p-table #dt
    [lazy]="true"
    [value]="messages"
    [columns]="cols"
    [paginator]="false"
    [autoLayout]="false"
    [responsive]="true"
    [totalRecords]="totalRecords"
    selectionMode="multiple"
    [metaKeySelection]="true"
    [scrollable]="false"
    (onRowSelect)="handleEvent('onRowSelect', $event)"

    [rowTrackBy]="trackByFn"
    > -->

<p-table #dt *ngIf="_selectedTag || _selectedFolder || _filters" [lazy]="true" (onLazyLoad)="lazyLoad($event)" scrollHeight="100%"
    [value]="mailListService.messages" [columns]="cols" [paginator]="false" [loading]="loading" [autoLayout]="true"
    [responsive]="true" [totalRecords]="totalRecords" [(selection)]="mailListService.selectedMessages"
    contextMenuSelectionMode="joint" selectionMode="multiple" [metaKeySelection]="true" [lazyLoadOnInit]="false"
    [rows]="rowsNmber" [rowTrackBy]="trackByFn" [contextMenu]="cm" [scrollable]="true"
    [virtualRowHeight]="virtualRowHeight" [virtualScroll]="true" [virtualScrollDelay]="150"
    (onRowSelect)="handleEvent('onRowSelect', $event)" (onRowUnselect)="handleEvent('onRowUnselect', $event)"
    (selectionChange)="handleEvent('selectionChange', $event)"
    (onContextMenuSelect)="handleEvent('onContextMenuSelect', $event)">
    <ng-template pTemplate="body" let-rowData let-message let-rowIndex="rowIndex">
        <tr #selRow class="message-row" [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex"
            [pContextMenuRow]="rowData">
            <td>
                <div class="mail-icons-container">
                    <!-- ICONE AZIONE -->
                    <!-- protocollato-->
                    <span class="mail-icon">
                        <ng-template  #registrationTemplate let-registrationstatus>
                            <i
                                [pTooltip]="registrationstatus === 'REGISTERED' ? 'Vedi dettagli protocollazione' :
                                    (registrationstatus === 'REGISTABLE' ? 'Protocolla il messaggio' : registrationstatus === 'IN_REGISTRATION' ? 'In protocollazione' : 'Il messaggio non può essere protocollato')"
                                tooltipPosition="top"
                                class="material-icons-outlined mail-icons icon-enabled"
                                [ngClass]="{'icon-disabled': registrationstatus === 'NOT_REGISTABLE', 'icon-used': registrationstatus === 'REGISTERED'}"
                                [ngStyle]="registrationstatus === 'REGISTERED' && {'color': 'darkcyan'} || registrationstatus === 'IN_REGISTRATION' && {'color': 'orange'}"
                                (click)="iconRegistrationClicked($event, message, registrationstatus)">
                                {{registrationstatus === 'REGISTERED' || registrationstatus === 'IN_REGISTRATION' ? "assignment_turned_in" : "assignment"}}
                                    <!-- (registrationstatus === "REGISTABLE" ? "assignment_returned" : "assignment_returned")}} -->
                            </i>
                            <p-menu appendTo="body" #registrationMenu [popup]="true" [model]="aziendeProtocollabiliSubCmItems"></p-menu>
                        </ng-template>
                        <ng-template [ngTemplateOutlet]="registrationTemplate"
                            [ngTemplateOutletContext]="{$implicit: getRegistrationStatus(message)}">
                        </ng-template>
                    </span>
                    <!-- reindirizzato -->
                    <span class="mail-icon">
                        <ng-template  #readdressTemplate let-readdressstatus>
                            <i [pTooltip]="readdressstatus === 'NOT_READDRESSABLE' ? 'Il messaggio non può essere reindirizzato' :
                                readdressstatus === 'READDRESSABLE' ? 'Reindirizza il messaggio' : 'Vedi dettagli reindirizzamento'"
                                tooltipPosition="top"
                                class="material-icons mail-icons icon-enabled"
                                [ngClass]="{'icon-disabled': readdressstatus === 'NOT_READDRESSABLE', 'icon-used': (readdressstatus !== 'NOT_READDRESSABLE' && readdressstatus !== 'READDRESSABLE')}"
                                [ngStyle]="(readdressstatus === 'FULL_READDRESSED' || 
                                    readdressstatus === 'READDRESSED_IN' || 
                                    readdressstatus === 'READDRESSED_OUT') && {'color': 'darkcyan'}"
                                (click)="iconReaddressClicked($event, message, readdressstatus)">
                                {{readdressstatus === 'NOT_READDRESSABLE' ? 'call_split' :
                                    readdressstatus === 'READDRESSABLE' ? 'call_split' : 'low_priority'}}
                            </i>
                        </ng-template>
                        <ng-template [ngTemplateOutlet]="readdressTemplate"
                            [ngTemplateOutletContext]="{$implicit: getReaddressStatus(message)}">
                        </ng-template>
                    </span>
                    <!-- annotato -->
                    <span class="mail-icon">
                        <ng-template  #annotatedTemplate let-annotatedstatus>
                            <i  [pTooltip]="annotatedstatus ? 'Visualizza la nota' : 'Aggiungi una nota'"
                                tooltipPosition="top"
                                class="material-icons-outlined mail-icons icon-enabled"
                                [ngStyle]="annotatedstatus && {'color': 'darkcyan'}"
                                (click)="noteHandler(message)">
                                {{annotatedstatus ? "insert_drive_file" : "note_add"}}
                            </i>
                        </ng-template>
                        <ng-template [ngTemplateOutlet]="annotatedTemplate"
                            [ngTemplateOutletContext]="{$implicit: isAlreadyTagged(message, 'annotated')}">
                        </ng-template>
                    </span>

                    <!-- SEPARATORE -->
                    <span *ngIf="message?.iconsVisibility?.replied  ||
                        message?.iconsVisibility?.replied_all ||
                        message?.iconsVisibility?.forwarded"
                        class="separatore">|
                    </span>

                    <!-- ICONE INFORMATIVE -->
                    <!-- se c'è risposto/risposto a tutti metto quello giusto risposto a tutti vince -->
                    <span *ngIf="message?.iconsVisibility?.replied || message?.iconsVisibility?.replied_all">
                        <span class="mail-icon"
                            [ngClass]="{'visibility-hidden':!message['iconsVisibility']['replied_all'] && !message['iconsVisibility']['replied']}">
                            <i [pTooltip]="getTagDescription('replied_all')" tooltipPosition="top"
                                *ngIf="message['iconsVisibility']['replied_all']; else reply_single"
                                class="material-icons mail-icons">reply_all</i>
                            <ng-template #reply_single><i [pTooltip]="getTagDescription('replied')"
                                    tooltipPosition="top" class="material-icons mail-icons">reply</i></ng-template>
                        </span>
                    </span>
                    <!-- se non c'è nè risposto, nè risposto a tutti lascio lo spazio vuoto -->
                    <span *ngIf="!message?.iconsVisibility?.replied && !message?.iconsVisibility?.replied_all"
                        class="mail-icon visibility-hidden"><i class="material-icons mail-icons">reply_all</i></span>
                    <!-- inoltra (se non c'è mette visibility-hidden per lasciare lo spazio vuoto ) -->
                    <span class="mail-icon" [ngClass]="{'visibility-hidden':!message?.iconsVisibility?.forwarded}"><i
                            [pTooltip]="getTagDescription('forwarded')" tooltipPosition="top"
                            class="material-icons mail-icons">forward</i></span>
                    <!-- assegnato (se non c'è mette visibility-hidden per lasciare lo spazio vuoto ) -->
                    <!-- <span class="mail-icon" [ngClass]="{'visibility-hidden':!message?.iconsVisibility?.assigned}"><i
                            [pTooltip]="getTagDescription('assigned')" tooltipPosition="top"
                            class="material-icons mail-icons">merge_type</i></span> -->

                    <!-- iconcina degli errori -->
                    <span class="second-line-icon"
                        [ngClass]="{'visibility-hidden':!(message?.iconsVisibility?.in_error || message.messageStatus === 'ERROR'),'warn-color': message?.iconsVisibility?.in_error}">
                        <i [pTooltip]="getTagDescription('in_error')" tooltipPosition="top"
                            class="material-icons second-line-icon icon-default-color">warning</i></span>
                    <!-- data della mail -->
                    <span class="mail-date">
                        {{message.receiveTime | date: 'EE d MMM y, H:mm' | titlecase}}
                    </span>
                    <!-- iconcina degli allegati -->
                    <span class="second-line-icon" [ngClass]="{'visibility-hidden':message?.attachmentsNumber === 0}"><i
                        [pTooltip]="message?.attachmentsNumber + ' allegati'" tooltipPosition="top"
                        class="material-icons second-line-icon">attach_file</i></span>
                </div>
                <div class="display-block">
                    <span class="pi pi-user display-icon icon-default-color"></span>
                    <div class="display-text" [ngClass]="{'display-bold':!message.seen}">{{message.fromOrTo}}</div>
                </div>
                <div class="display-block extra-margin">
                    <!-- iconcina della mail -->
                    <span *ngIf="!message?.seen" class="fas fa-envelope display-icon envelope-icon icon-default-color"></span>
                    <span *ngIf="message?.seen" class="far fa-envelope-open display-icon envelope-icon"></span>

                    <!-- nome della cartella in cui si trova la mail in caso di risultati di una ricerca su tutta la casella -->
                    <span *ngIf="(_filters && !_selectedFolder) || _selectedTag"
                        class="display-text text-background">{{message?.messageFolderList[0]?.idFolder.description}}</span>

                    <!-- oggetto della mail -->
                    <span class="display-text" [ngClass]="{'display-bold':!message.seen}">{{message.subject}}</span>
                    <!-- <div class="display-text" [ngClass]="{'display-bold':!message.seen}">{{message.id + " -- " + message.subject}}</div>  -->
                </div>
            </td>
        </tr>
    </ng-template>
    <!-- <ng-template pTemplate="loadingbody" let-columns="columns">
        <tr style="height:68px">
            <td *ngFor="let col of columns">
                <div class="loading-text"></div>
            </td>
        </tr>
    </ng-template> -->

</p-table>
<div *ngIf="!(_selectedTag || _selectedFolder || _filters)" class="flex-1 message-align flex-direction-col">
    <p style="margin: 0">Non ci sono elementi da visualizzare.</p>
    <p style="margin: 0.5em">Selezionare una cartella o effettuare una ricerca.</p>
</div>
<p-contextMenu #cm [model]="cmItems" styleClass="context-menu-mail-list"></p-contextMenu>

<p-confirmDialog acceptLabel="Sì" rejectLabel="No" [style]="{width: '20vw', top: '40%'}"></p-confirmDialog>
<!-- "{'margin': '-128px 0 0 -312px'}" -->
<p-dialog header="Nota messaggio" [(visible)]="displayNote" [modal]="true" [closable]="false" [responsive]="true"
    [style]="{width: '350px', minWidth: '264px'}" [minY]="60" [baseZIndex]="10000">
    <div class="flex-1" style="height: 100%; min-height: 80px;">
            <textarea #noteArea class="flex-1 note-area" pInputTextarea placeholder="Inserisci nota"
            [(ngModel)]="noteObject.memo"></textarea>
    </div>
    <p-footer>
        <button type="button" pButton icon="pi pi-check" (click)="handleEvent('saveNote', '')" label="Conferma"
            class="confirm-buttons ui-button-raised ui-button-secondary custom-secondary-button">
        </button>
        <button type="button" pButton icon="pi pi-times" (click)="displayNote=false" label="Annulla"
            class="confirm-buttons ui-button-raised ui-button-secondary custom-secondary-button">
        </button>
    </p-footer>
</p-dialog>


<!-- DIALOG DI PROTOCOLLAZIONE -->
<p-dialog [(visible)]="displayProtocollaDialog" [visible]="displayProtocollaDialog">
    <p-header>
        Protocolla Pec
    </p-header>
    <div style="height: 50px; padding-top: 10px;">
        Vuoi creare un nuovo documento, oppure aggiungere ad una bozza già creata?
    </div>
    <p-footer>
        <div class="p-grid p-justify-even">
            <button type="button" pButton (click)="chooseRegistrationType(null, 'NEW')" label="Crea Nuovo"
                class="ui-button-raised ui-button-secondary custom-secondary-button">
            </button>
            <button type="button" pButton (click)="chooseRegistrationType(null, 'ADD')"
                label="Aggiungi a bozza già creata"
                class="ui-button-raised ui-button-secondary custom-secondary-button">
            </button>
        </div>
    </p-footer>
</p-dialog>

<!-- DIALOG CHE MOSTRA IL DETTAGLIO DELLA PROTOCOLLAZIONE -->
<p-dialog [(visible)]="displayRegistrationDetail">
    <p-header>
        Dettaglio protocollazione
    </p-header>
    <div>Il {{registrationDetail?.data}}: {{registrationDetail?.idUtente?.descrizione}} ha protocollato il messaggio.</div>
    <div *ngIf="registrationDetail?.numeroProtocollo">{{registrationDetail?.registro}}{{registrationDetail?.numeroProtocollo}}/{{registrationDetail?.anno}}: {{registrationDetail?.oggetto}}</div>
    <div *ngIf="!registrationDetail?.numeroProtocollo">Prop. {{registrationDetail?.numeroProposta}}: {{registrationDetail?.oggetto}}</div>
    <p-footer>
        <button type="button" pButton (click)="displayRegistrationDetail = false" label="Ok"></button>
    </p-footer>
</p-dialog>

<!-- DIALOG CHE MOSTRA IL DETTAGLIO DEL REINDIRIZZAMENTO -->
<p-dialog [(visible)]="readdressDetail.displayReaddressDetail">
    <p-header>
        Dettaglio reindirizzamenti
    </p-header>
    <li *ngIf="readdressDetail.testo?.in" [innerHTML]="readdressDetail.testo.in"></li>
    <li *ngIf="readdressDetail.testo?.out" [innerHTML]="readdressDetail.testo.out"></li>
    <p-footer class="button-readdress">
        <button *ngIf="readdressDetail.buttonReaddress" type="button" pButton
            (click)="iconReaddressClicked($event, readdressDetail.message, 'READDRESSABLE')"
            (click)="readdressDetail.displayReaddressDetail = false"
            label="Aggiungi"
            class="ui-button-raised ui-button-secondary button-styles custom-secondary-button">
        </button>
        <button type="button" pButton
            (click)="readdressDetail.displayReaddressDetail = false"
            label="Ok"
            class="ui-button-raised ui-button-secondary button-styles custom-secondary-button">
        </button>
    </p-footer>
</p-dialog>
